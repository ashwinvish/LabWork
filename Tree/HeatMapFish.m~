function [plotVol,m,I] = HeatMapFish( ksize,res, PointCloud, Soma, CellID ,figure )
%HeatMap used to plot the heatmap of a PointCloud for a CellID centered at
%Soma
%   PointCloud [X Y Z]  is the point of clouds over which the density is computed,
%   e.g clould be presynaptic coordinates.
%   ksize is the size of the kernel in same unit as coordinates ( here in
%   nm)
%   res is the downsampling factor
%   Soma (x y z) is the coordinates of the cell soma
%   CellID is the string to ID the cell

ksize = ksize/res; % downsample the kernel size

Gwin = gausswin(ksize+1);
K = Gwin*Gwin';

for i = 1:(ksize+1)
    K3D(:,:,i) = K(:,:)*Gwin(i);
end

vol = zeros( ksize + (14e4-0)/res + ksize , ksize + (2.5e5-0)/res + ksize , ksize + (6e4-0)/res + ksize); % size of volume is prefixed


% add 10000/res pixels to the zaxis to avoid edge effects
for n = 1:size(PointCloud,1);
    vol(round(PointCloud(n,1)/res + ksize/2) + (-ksize/2:ksize/2), round(PointCloud(n,2)/res + ksize/2) + (-ksize/2:ksize/2), round(PointCloud(n,3)/res + ksize/2 +1)+ (-ksize/2:ksize/2)) = ...
        vol(round(PointCloud(n,1)/res + ksize/2) + (-ksize/2:ksize/2), round(PointCloud(n,2)/res + ksize/2) + (-ksize/2:ksize/2),round(PointCloud(n,3)/res + ksize/2 +1)+ (-ksize/2:ksize/2))  + K3D;
end

vol = vol./max(vol(:)); % normalize volume
plotVol = 

if figure ==true
    threeView(vol(20+ksize/2 : 140+ksize/2, 60+ksize/2 : 250+ksize/2, ksize/2:60+ksize/2),jet);
    title(CellID);
    
    %plot XZ soma location
    plot(140-(Soma(1,1)/res), 60 -(Soma(1,3))/res,'Marker','o', 'MarkerFaceColor','w', 'MarkerEdgeColor','k');
    %plot XY soma location
    plot(140-(Soma(1,1)/res), 10 + (Soma(1,2))/res,'Marker','o', 'MarkerFaceColor','w', 'MarkerEdgeColor','k');
    %plot YZ soma location
    plot(130+(Soma(1,3)/res), 10 + (Soma(1,2))/res,'Marker','o', 'MarkerFaceColor','w', 'MarkerEdgeColor','K');
    
    axis off
    axis vis3d
    [m,I] = max(vol(:));
    
else
    
    [m,I] = max(vol(:));
end

end

